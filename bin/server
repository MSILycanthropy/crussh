#!/usr/bin/env ruby
# frozen_string_literal: true

require "bundler/setup"
require "crussh"

class ShellHandler < Crussh::Handler
  def handle
    puts "Hello, #{user}!"
    puts "Type 'exit' to quit."
    puts

    each_line(prompt: "> ", echo: pty?) do |line|
      case line.strip
      when "exit"
        break
      when ""
        next
      else
        puts "You said: #{line}"
      end
    end

    puts "Goodbye!"
    exit_status(0)
    close
  end
end

class ExecHandler < Crussh::Handler
  def setup(command)
    @command = command
  end

  def handle
    puts "Executing: #{@command}"

    IO.popen(@command, err: [:child, :out]) do |io|
      IO.copy_stream(io, channel)
    end

    status = $CHILD_STATUS
    if status.signaled?
      exit_signal(Signal.signame(status.termsig), core_dumped: status.coredump?)
    else
      exit_status(status.exitstatus)
    end

    close
  end
end

class DevServer < Crussh::Server
  configure do |config|
    config.host = "0.0.0.0"
    config.port = 2222
    config.generate_host_keys!
  end

  banner "Welcome to Crussh!\n\n"

  authenticate :none do |_|
    true
  end

  authenticate :publickey do |username, key|
    Crussh::Logger.debug(self, "Accepting key", user: username, fingerprint: key.fingerprint)
    true
  end

  accept :pty
  accept :env, only: ["TERM", "LANG", "LC_*"]

  handle :shell, ShellHandler
  handle :exec, ExecHandler
end

Sync do
  puts "Starting Crussh test server..."
  puts "Test with: ssh -v localhost -p 2222"
  puts

  DevServer.run
end
