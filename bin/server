#!/usr/bin/env ruby
# frozen_string_literal: true

require "bundler/setup"
require "crussh"

class ShellHandler < Crussh::Handler
  def handle
    puts "Echo server. Type 'quit' to exit."
    puts

    loop do
      text = gets.chomp

      break if text == "quit"

      puts(text)
    end

    exit_status(0)
    close
  end
end

class ExecHandler < Crussh::Handler
  def setup(command)
    @command = command
  end

  def handle
    IO.popen(@command, err: [:child, :out]) do |io|
      IO.copy_stream(io, channel)
    end

    status = $CHILD_STATUS
    if status.signaled?
      exit_signal(Signal.signame(status.termsig), core_dumped: status.coredump?)
    else
      exit_status(status.exitstatus)
    end

    close
  end
end

class DevServer < Crussh::Server
  configure do |config|
    config.host = "0.0.0.0"
    config.port = 2222
    config.generate_host_keys!
  end

  authenticate :none do |_|
    true
  end

  accept :pty

  handle :shell, ShellHandler
  handle :exec, ExecHandler
end

Sync do
  puts "Starting Crussh test server..."
  puts "Test with: ssh -v localhost -p 2222"
  puts

  DevServer.run
end
